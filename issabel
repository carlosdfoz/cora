#!/bin/bash

# Script de Configuração de Domínio para Issabel/FreePBX com SIP
# Rocky Linux 8
# Executar como root

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Configurações
DOMAIN="traysistemas.vps-kinghost.net"
SERVER_IP="177.153.60.150"

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}Configuração de Domínio Issabel/SIP${NC}"
echo -e "${GREEN}========================================${NC}"
echo -e "Domínio: ${YELLOW}$DOMAIN${NC}"
echo -e "IP: ${YELLOW}$SERVER_IP${NC}"
echo ""

# Verificar se está rodando como root
if [ "$EUID" -ne 0 ]; then 
    echo -e "${RED}Por favor, execute como root${NC}"
    exit 1
fi

# Backup de arquivos importantes
echo -e "${GREEN}[1/8]${NC} Criando backups..."
mkdir -p /root/backup_issabel_$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/root/backup_issabel_$(date +%Y%m%d_%H%M%S)"

cp /etc/asterisk/sip_general_custom.conf "$BACKUP_DIR/" 2>/dev/null
cp /etc/asterisk/sip.conf "$BACKUP_DIR/" 2>/dev/null
cp /etc/hosts "$BACKUP_DIR/"
cp /etc/hostname "$BACKUP_DIR/" 2>/dev/null

echo -e "${GREEN}Backups salvos em: $BACKUP_DIR${NC}"

# Configurar hostname
echo -e "${GREEN}[2/8]${NC} Configurando hostname..."
hostnamectl set-hostname $DOMAIN
echo "$SERVER_IP $DOMAIN $(echo $DOMAIN | cut -d'.' -f1)" >> /etc/hosts

# Verificar se o Asterisk está instalado
echo -e "${GREEN}[3/8]${NC} Verificando instalação do Asterisk..."
if ! command -v asterisk &> /dev/null; then
    echo -e "${RED}Asterisk não encontrado. Por favor, instale o Issabel primeiro.${NC}"
    exit 1
fi

# Configurar SIP
echo -e "${GREEN}[4/8]${NC} Configurando SIP..."

# Adicionar configurações ao sip_general_custom.conf
cat >> /etc/asterisk/sip_general_custom.conf << EOF

; Configuração de Domínio - $DOMAIN
externhost=$DOMAIN
externip=$SERVER_IP
externrefresh=10
localnet=192.168.0.0/255.255.0.0
localnet=10.0.0.0/255.0.0.0
localnet=172.16.0.0/255.240.0.0

; Configurações de NAT
nat=force_rport,comedia
directmedia=no

; Configurações de transporte
transport=udp,tcp,tls

; Domínio SIP
domain=$DOMAIN
allowguest=no
alwaysauthreject=yes
EOF

# Configurar portas do firewall
echo -e "${GREEN}[5/8]${NC} Configurando firewall..."

# Habilitar firewalld se não estiver
systemctl enable firewalld
systemctl start firewalld

# Portas SIP
firewall-cmd --permanent --add-service=sip
firewall-cmd --permanent --add-port=5060/udp
firewall-cmd --permanent --add-port=5060/tcp
firewall-cmd --permanent --add-port=5061/tcp

# Portas RTP (áudio)
firewall-cmd --permanent --add-port=10000-20000/udp

# Portas Web
firewall-cmd --permanent --add-service=http
firewall-cmd --permanent --add-service=https
firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --permanent --add-port=443/tcp

# Recarregar firewall
firewall-cmd --reload

echo -e "${GREEN}Firewall configurado${NC}"

# Configurar SELinux (se estiver ativo)
echo -e "${GREEN}[6/8]${NC} Verificando SELinux..."
if [ "$(getenforce)" != "Disabled" ]; then
    echo -e "${YELLOW}SELinux está ativo. Configurando permissões...${NC}"
    setsebool -P httpd_can_network_connect on
    setsebool -P httpd_can_network_connect_db on
fi

# Reiniciar serviços
echo -e "${GREEN}[7/8]${NC} Reiniciando serviços..."
systemctl restart asterisk
systemctl restart httpd 2>/dev/null || systemctl restart nginx 2>/dev/null

# Verificar status dos serviços
echo -e "${GREEN}[8/8]${NC} Verificando status dos serviços..."
echo ""

if systemctl is-active --quiet asterisk; then
    echo -e "${GREEN}✓${NC} Asterisk: Rodando"
else
    echo -e "${RED}✗${NC} Asterisk: Parado"
fi

if systemctl is-active --quiet httpd || systemctl is-active --quiet nginx; then
    echo -e "${GREEN}✓${NC} Web Server: Rodando"
else
    echo -e "${RED}✗${NC} Web Server: Parado"
fi

# Mostrar informações de configuração
echo ""
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}Configuração Concluída!${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""
echo -e "Domínio configurado: ${YELLOW}$DOMAIN${NC}"
echo -e "IP do servidor: ${YELLOW}$SERVER_IP${NC}"
echo ""
echo -e "${YELLOW}Próximos passos:${NC}"
echo "1. Configure seu DNS para apontar $DOMAIN para $SERVER_IP"
echo "2. Acesse o painel: http://$DOMAIN ou https://$DOMAIN"
echo "3. Configure os ramais SIP no Issabel"
echo ""
echo -e "${YELLOW}Configurações SIP:${NC}"
echo "- Servidor SIP: $DOMAIN"
echo "- Porta: 5060 (UDP/TCP)"
echo "- Porta TLS: 5061 (TCP)"
echo ""
echo -e "${YELLOW}Para verificar configuração SIP:${NC}"
echo "asterisk -rx 'sip show settings'"
echo ""
echo -e "${GREEN}Backups salvos em: $BACKUP_DIR${NC}"
echo ""

# Testar conectividade Asterisk
echo -e "${YELLOW}Testando Asterisk...${NC}"
asterisk -rx 'core show version'
echo ""
asterisk -rx 'sip show settings' | grep -E "externhost|externip|domain"

echo ""
echo -e "${GREEN}Script finalizado com sucesso!${NC}"
