#!/bin/bash

# Script de Limpeza de Mem√≥ria RAM FreeSWITCH - USO √öNICO
# Para FusionPBX no Debian 12
# Execute como root para limpeza imediata

echo "=================================================="
echo "    LIMPEZA DE MEM√ìRIA FREESWITCH - USO √öNICO"
echo "=================================================="
echo ""

# Verificar se √© root
if [[ $EUID -ne 0 ]]; then
    echo "ERRO: Este script deve ser executado como root"
    echo "Use: sudo $0"
    exit 1
fi

# Verificar se FreeSWITCH est√° rodando
if ! pgrep -f "freeswitch" > /dev/null; then
    echo "ERRO: FreeSWITCH n√£o est√° em execu√ß√£o"
    exit 1
fi

# Fun√ß√£o para obter mem√≥ria do FreeSWITCH
get_memory_usage() {
    local memory_kb=$(ps -u freeswitch -o rss= | awk '{sum+=$1} END {print sum}')
    if [[ -z "$memory_kb" ]]; then
        echo "0"
    else
        echo $((memory_kb / 1024))
    fi
}

# Mem√≥ria antes da limpeza
MEMORIA_ANTES=$(get_memory_usage)
echo "üìä Mem√≥ria do FreeSWITCH antes: ${MEMORIA_ANTES}MB"
echo ""

# Perguntar confirma√ß√£o
read -p "Deseja continuar com a limpeza? (s/N): " confirm
if [[ ! "$confirm" =~ ^[Ss]$ ]]; then
    echo "Opera√ß√£o cancelada pelo usu√°rio"
    exit 0
fi

echo ""
echo "üîÑ Iniciando processo de limpeza..."
echo ""

# 1. Limpar cache do sistema
echo "1. Limpando cache do sistema..."
sync
echo 3 > /proc/sys/vm/drop_caches
echo "‚úÖ Cache do sistema limpo"
echo ""

# 2. Limpar logs tempor√°rios
echo "2. Limpando logs tempor√°rios..."
find /var/log/freeswitch -name "*.log.*" -type f -mtime +1 -delete 2>/dev/null
echo "‚úÖ Logs tempor√°rios removidos"
echo ""

# 3. Recarregar perfis Sofia
echo "3. Recarregando perfis Sofia..."
timeout 10s /usr/bin/fs_cli -q -x "sofia profile internal restart" 2>/dev/null
timeout 10s /usr/bin/fs_cli -q -x "sofia profile external restart" 2>/dev/null
sleep 3
echo "‚úÖ Perfis Sofia recarregados"
echo ""

# 4. Recarregar configura√ß√µes
echo "4. Recarregando configura√ß√µes..."
timeout 10s /usr/bin/fs_cli -q -x "reloadxml" 2>/dev/null
timeout 10s /usr/bin/fs_cli -q -x "reloadacl" 2>/dev/null
echo "‚úÖ Configura√ß√µes recarregadas"
echo ""

# 5. Limpar sess√µes √≥rf√£s (apenas se n√£o houver chamadas ativas)
echo "5. Verificando sess√µes ativas..."
ACTIVE_CALLS=$(timeout 5s /usr/bin/fs_cli -q -x "show calls count" 2>/dev/null | grep -o '[0-9]\+' | head -1)

if [[ -z "$ACTIVE_CALLS" ]]; then
    ACTIVE_CALLS=0
fi

if [[ $ACTIVE_CALLS -eq 0 ]]; then
    echo "   Nenhuma chamada ativa, limpando sess√µes √≥rf√£s..."
    timeout 10s /usr/bin/fs_cli -q -x "hupall" 2>/dev/null
    echo "‚úÖ Sess√µes √≥rf√£s removidas"
else
    echo "   ‚ö†Ô∏è  Chamadas ativas detectadas: $ACTIVE_CALLS"
    echo "   Pulando limpeza de sess√µes para evitar interrup√ß√µes"
fi
echo ""

# 6. Limpar cache interno do FreeSWITCH
echo "6. Limpando cache interno..."
timeout 5s /usr/bin/fs_cli -q -x "nat_map flush" 2>/dev/null
timeout 5s /usr/bin/fs_cli -q -x "db flush" 2>/dev/null
echo "‚úÖ Cache interno limpo"
echo ""

# Aguardar estabiliza√ß√£o
echo "‚è≥ Aguardando estabiliza√ß√£o do sistema..."
sleep 5

# Mem√≥ria ap√≥s a limpeza
MEMORIA_DEPOIS=$(get_memory_usage)
MEMORIA_LIBERADA=$((MEMORIA_ANTES - MEMORIA_DEPOIS))

echo ""
echo "=================================================="
echo "             RESULTADO DA LIMPEZA"
echo "=================================================="
echo "üìä Mem√≥ria antes: ${MEMORIA_ANTES}MB"
echo "üìä Mem√≥ria depois: ${MEMORIA_DEPOIS}MB"

if [[ $MEMORIA_LIBERADA -gt 0 ]]; then
    echo "‚úÖ Mem√≥ria liberada: ${MEMORIA_LIBERADA}MB"
elif [[ $MEMORIA_LIBERADA -eq 0 ]]; then
    echo "‚ÑπÔ∏è  Nenhuma mem√≥ria adicional liberada"
else
    echo "‚ö†Ô∏è  Mem√≥ria aumentou: $((MEMORIA_DEPOIS - MEMORIA_ANTES))MB"
fi

# Verificar uso de disco
DISK_USAGE=$(df /var --output=pcent | tail -1 | tr -d ' %')
echo "üíæ Uso de disco /var: ${DISK_USAGE}%"

echo ""
echo "‚úÖ Limpeza conclu√≠da!"
echo "=================================================="

# Verificar status do FreeSWITCH
if systemctl is-active --quiet freeswitch; then
    echo "üéØ FreeSWITCH est√° rodando normalmente"
else
    echo "‚ùå ALERTA: FreeSWITCH n√£o est√° rodando!"
    echo "Tente reiniciar: systemctl start freeswitch"
fi
